<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>File Upload Page</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
      }
      #container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 80%;
      }
      #left-side {
        width: 40%;
      }
      #right-side {
        width: 40%;
        text-align: center;
        border-left: 2px solid #ccc;
        padding-left: 20px;
      }
      #drag-drop-area {
        border: 2px dashed #ccc;
        padding: 20px;
        margin-bottom: 20px;
      }
      #progress-bar {
        display: none;
        height: 20px;
        background-color: #0074d9;
        width: 0;
        margin-top: 10px;
      }
      #downloadLink {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="left-side">
        <input
          type="text"
          id="passphraseInput"
          placeholder="Enter 24-word Passphrase"
        />
        <button id="deleteButton" disabled>Delete</button>
        <button id="downloadButton" disabled>Download</button>
      </div>
      <div id="right-side">
        <div id="drag-drop-area">
          <span id="file-name-display">Select or Drag 'n' Drop a File</span>
        </div>
        <input type="file" id="fileInput" style="display: none" />
        <button id="chooseFileButton">Choose File</button>
        <button id="uploadButton" disabled>Upload</button>
        <div id="progress-bar"></div>
        <div id="resultMessage"></div>
        <a id="downloadLink" style="display: none" download></a>
      </div>
    </div>

    <script>
      const passphraseInput = document.getElementById("passphraseInput");
      const deleteButton = document.getElementById("deleteButton");
      const downloadButton = document.getElementById("downloadButton");
      const dragDropArea = document.getElementById("drag-drop-area");
      const fileNameDisplay = document.getElementById("file-name-display");
      const fileInput = document.getElementById("fileInput");
      const chooseFileButton = document.getElementById("chooseFileButton");
      const uploadButton = document.getElementById("uploadButton");
      const progressBar = document.getElementById("progress-bar");
      const resultMessage = document.getElementById("resultMessage");
      const downloadLink = document.getElementById("downloadLink");

      // Function to check if the passphrase is valid (24 words separated by spaces)
      function isPassphraseValid(passphrase) {
        const words = passphrase.split(" ");
        return words.length === 24 && words.every((word) => word.trim() !== "");
      }

      passphraseInput.addEventListener("input", () => {
        const passphrase = passphraseInput.value;
        const isValid = isPassphraseValid(passphrase);
        deleteButton.disabled = !isValid;
        downloadButton.disabled = !isValid;
      });

      chooseFileButton.addEventListener("click", () => {
        fileInput.click();
      });

      fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        if (file) {
          fileNameDisplay.textContent = file.name;
          uploadButton.removeAttribute("disabled");
        }
      });

      uploadButton.addEventListener("click", () => {
        const file = fileInput.files[0];
        if (file) {
          uploadFile(file);
        }
      });

      deleteButton.addEventListener("click", () => {
        const passphrase = passphraseInput.value;
        if (isPassphraseValid(passphrase)) {
          deleteFile(passphrase);
        }
      });

      downloadButton.addEventListener("click", () => {
        const passphrase = passphraseInput.value;
        if (isPassphraseValid(passphrase)) {
          retrieveFile(passphrase);
        }
      });

      dragDropArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        dragDropArea.style.border = "2px dashed #0074d9";
      });

      dragDropArea.addEventListener("dragleave", () => {
        dragDropArea.style.border = "2px dashed #ccc";
      });

      dragDropArea.addEventListener("drop", (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file) {
          fileInput.files = e.dataTransfer.files;
          fileNameDisplay.textContent = file.name;
          uploadButton.removeAttribute("disabled");
        }
        dragDropArea.style.border = "2px dashed #ccc";
      });

      function uploadFile(file) {
        progressBar.style.width = "0";
        progressBar.style.backgroundColor = "#0074d9";
        progressBar.style.display = "block";
        resultMessage.textContent = "";

        const formData = new FormData();
        formData.append("file", file);

        fetch(`https://bipper.maxkienitz.com/store/${file.name}`, {
          method: "POST",
          body: formData,
        })
          .then((response) => response.text())
          .then((message) => {
            progressBar.style.backgroundColor = "green";
            progressBar.style.display = "none";
            resultMessage.textContent = message;
          })
          .catch((error) => {
            progressBar.style.backgroundColor = "red";
            resultMessage.textContent = "Error uploading the file.";
          });
      }

      function deleteFile(passphrase) {
        resultMessage.textContent = "";
        fetch(`https://bipper.maxkienitz.com/delete`, {
          method: "POST",
          body: JSON.stringify({ mnemonic: passphrase }),
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.text())
          .then((message) => {
            resultMessage.textContent = message;
          })
          .catch((error) => {
            resultMessage.textContent = "Error deleting the file.";
          });
      }

      function retrieveFile(passphrase) {
        resultMessage.textContent = "";
        fetch(`https://bipper.maxkienitz.com/retrieve`, {
          method: "POST",
          body: JSON.stringify({ mnemonic: passphrase }),
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.blob())
          .then((blob) => {
            const dispositionHeader = response.headers.get(
              "Content-Disposition",
            );
            const filenameMatch = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(
              dispositionHeader,
            );
            const suggestedFileName = filenameMatch
              ? filenameMatch[1]
              : "downloaded_file.txt";

            const url = window.URL.createObjectURL(blob);
            downloadLink.href = url;
            downloadLink.download = suggestedFileName;
            downloadLink.style.display = "block";
            resultMessage.textContent =
              "File retrieved successfully. Click Download to save.";
          })
          .catch((error) => {
            resultMessage.textContent = "Error retrieving the file.";
          });
      }
    </script>
  </body>
</html>
